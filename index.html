<script>
    // Supabase Configuration
    const supabaseUrl = "https://qmkcaefbboenlojpedax.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    let currentRoomId = null;
    let currentUser = prompt('Please enter your name:') || 'Anonymous';
    let messageSubscription = null;

    // Load available rooms
    async function loadRooms() {
        const { data: rooms, error } = await supabase.from('rooms').select('id, name');
        const availableRoomsList = document.getElementById('availableRooms');
        availableRoomsList.innerHTML = '';

        if (rooms && rooms.length > 0) {
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.textContent = room.name;
                li.dataset.roomId = room.id;
                li.addEventListener('click', () => {
                    document.getElementById('roomInput').value = room.name;
                });
                availableRoomsList.appendChild(li);
            });
        } else {
            availableRoomsList.innerHTML = '<li>No rooms available</li>';
        }
    }

    loadRooms();

    // Join Room
    document.getElementById('joinRoom').addEventListener('click', async () => {
        const roomName = document.getElementById('roomInput').value.trim();
        if (!roomName) return alert('Please enter a valid room name.');

        const { data: room, error } = await supabase.from('rooms').select('id, name').eq('name', roomName).single();
        if (error || !room) return alert('Room not found.');

        currentRoomId = room.id;
        document.getElementById('chatSection').style.display = 'block';
        document.getElementById('roomName').textContent = room.name;
        document.getElementById('messages').innerHTML = '';

        // Load existing messages
        const { data: messages, error: messagesError } = await supabase
            .from('messages')
            .select('*')
            .eq('room_id', currentRoomId)
            .order('created_at', { ascending: true });

        if (messagesError) console.error(messagesError);

        messages.forEach(msg => addMessage(msg.user_name, msg.content, new Date(msg.created_at)));

        // Subscribe to real-time messages
        subscribeToMessages();
    });

    // Subscribe to messages in real-time
    function subscribeToMessages() {
        if (messageSubscription) messageSubscription.unsubscribe(); // Unsubscribe previous

        messageSubscription = supabase
            .from('messages')
            .on('INSERT', payload => {
                if (payload.new.room_id === currentRoomId) {
                    addMessage(payload.new.user_name, payload.new.content, new Date(payload.new.created_at));
                }
            })
            .subscribe();
    }

    // Send Message
    document.getElementById('sendMessage').addEventListener('click', async () => {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!currentRoomId || !message) return alert('Please join a room and type a message.');

        const { error } = await supabase.from('messages').insert([
            { room_id: currentRoomId, user_name: currentUser, content: message }
        ]);

        if (error) console.error(error);
        messageInput.value = '';
    });

    // Helper function to add a message to the chat
    function addMessage(sender, content, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.innerHTML = `<span class="sender">${sender}:</span> ${content} <span class="time">${timestamp.toLocaleTimeString()}</span>`;
        const messagesDiv = document.getElementById('messages');
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
    }
</script>
