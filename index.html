<!DOCTYPE html>
<html lang="en">
<!-- ... (all the previous head content and styles remain the same) ... -->
<body>
    <div id="chat-app">
        <!-- ... (all the previous HTML content remains the same) ... -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ... (previous code remains the same until joinRoom event listener) ...

        // Fixed Join Room Event Listener
        document.getElementById('joinRoom').addEventListener('click', async () => {
            const roomName = document.getElementById('roomInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (!roomName) {
                alert('Please enter a room name.');
                return;
            }

            try {
                // First, check if the room exists and get its details
                const { data: room, error: roomError } = await supabase
                    .from('rooms')
                    .select('*')
                    .eq('name', roomName)
                    .eq('is_archived', false)
                    .single();

                if (roomError || !room) {
                    throw new Error('Room not found or has been archived');
                }

                // Check password if room has one
                if (room.password && room.password !== password) {
                    alert('Incorrect password');
                    return;
                }

                // Set current room details
                currentRoom = room.name;
                currentRoomId = room.id;

                // Update UI
                document.getElementById('chatSection').style.display = 'block';
                document.getElementById('roomName').textContent = currentRoom;
                document.getElementById('messages').innerHTML = '';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInputDiv').style.display = 'none';

                // Load existing messages
                await loadMessages();

                // Setup real-time subscription
                if (messageSubscription) {
                    messageSubscription.unsubscribe();
                }
                
                subscribeToMessages(currentRoomId);

                // Update room activity
                await updateRoomActivity(currentRoomId);

            } catch (error) {
                console.error('Error joining room:', error);
                alert(error.message || 'Error joining room. Please try again.');
            }
        });

        // Function to load messages
        async function loadMessages() {
            if (!currentRoomId) return;

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('room_id', currentRoomId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                messages.forEach(message => {
                    addMessage(message.user_name, message.content, new Date(message.created_at));
                });

                scrollToBottom();
            } catch (error) {
                console.error('Error loading messages:', error);
                alert('Error loading messages. Please try again.');
            }
        }

        // Improved subscribeToMessages function
        function subscribeToMessages(roomId) {
            if (messageSubscription) {
                messageSubscription.unsubscribe();
            }

            messageSubscription = supabase
                .channel(`room-${roomId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `room_id=eq.${roomId}`
                }, payload => {
                    console.log('New message received:', payload);
                    addMessage(payload.new.user_name, payload.new.content, new Date(payload.new.created_at));
                    scrollToBottom();
                })
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });
        }

        // ... (rest of your code remains the same) ...
    </script>
</body>
</html>
