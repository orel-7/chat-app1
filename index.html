<!DOCTYPE html>
<html lang="en">
<!-- Previous head section remains the same -->
<body>
    <div id="chat-app">
        <h2>Supabase Chat</h2>
        
        <div class="room-input">
            <label for="roomInput">Enter Room Name:</label>
            <input type="text" id="roomInput" placeholder="e.g., General Chat">
            <div class="password-input">
                <label for="passwordInput">Room Password (optional):</label>
                <input type="password" id="passwordInput" placeholder="Enter password">
            </div>
            <button id="joinRoom">Join Room</button>
            <button id="createRoomButton">Create New Room</button>
            <button id="restoreRoom">Restore Archived Room</button>
        </div>

        <!-- Previous HTML structure remains the same -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Previous configuration remains the same

        // Function to update room activity
        async function updateRoomActivity(roomId) {
            try {
                await supabase
                    .from('rooms')
                    .update({ last_activity: new Date().toISOString() })
                    .eq('id', roomId);
            } catch (error) {
                console.error('Error updating room activity:', error);
            }
        }

        // Modified loadRooms function
        async function loadRooms() {
            try {
                const { data: rooms, error } = await supabase
                    .from('rooms')
                    .select('id, name')
                    .eq('is_archived', false)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                const availableRoomsList = document.getElementById('availableRooms');
                availableRoomsList.innerHTML = '';
                
                if (rooms && rooms.length > 0) {
                    rooms.forEach(room => {
                        const li = document.createElement('li');
                        li.textContent = room.name;
                        li.dataset.roomId = room.id;
                        li.addEventListener('click', () => {
                            document.getElementById('roomInput').value = room.name;
                        });
                        availableRoomsList.appendChild(li);
                    });
                } else {
                    availableRoomsList.innerHTML = '<li>No active rooms available</li>';
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                alert('Error loading rooms. Please try again.');
            }
        }

        // Restore archived room
        document.getElementById('restoreRoom').addEventListener('click', async () => {
            const roomName = prompt('Enter room name to restore:');
            const password = prompt('Enter room password:');
            
            if (roomName && password) {
                try {
                    const { data: room, error } = await supabase
                        .from('rooms')
                        .select('*')
                        .eq('name', roomName)
                        .eq('is_archived', true)
                        .single();

                    if (error || !room) {
                        throw new Error('Room not found or not archived');
                    }

                    if (room.password !== password) {
                        throw new Error('Incorrect password');
                    }

                    // Restore room
                    const { error: updateError } = await supabase
                        .from('rooms')
                        .update({ 
                            is_archived: false,
                            last_activity: new Date().toISOString()
                        })
                        .eq('id', room.id);

                    if (updateError) throw updateError;

                    alert('Room restored successfully!');
                    loadRooms();
                } catch (error) {
                    console.error('Error restoring room:', error);
                    alert(error.message);
                }
            }
        });

        // Modified Send Message function
        document.getElementById('sendMessage').addEventListener('click', async () => {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (currentRoomId && message) {
                try {
                    // Update room activity
                    await updateRoomActivity(currentRoomId);

                    const { error } = await supabase
                        .from('messages')
                        .insert([
                            {
                                room_id: currentRoomId,
                                user_name: currentUser,
                                content: message
                            }
                        ]);
                    
                    if (error) throw error;
                    messageInput.value = '';
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Error sending message. Please try again.');
                }
            } else if (!currentRoomId) {
                alert('Please join a room first.');
            } else {
                alert('Message cannot be empty.');
            }
        });

        // Add activity check interval
        setInterval(async () => {
            if (currentRoomId) {
                try {
                    const { data: room, error } = await supabase
                        .from('rooms')
                        .select('is_archived')
                        .eq('id', currentRoomId)
                        .single();

                    if (error) throw error;

                    if (room.is_archived) {
                        alert('This room has been archived due to inactivity. You can restore it using the password.');
                        currentRoom = null;
                        currentRoomId = null;
                        document.getElementById('chatSection').style.display = 'none';
                        loadRooms();
                    }
                } catch (error) {
                    console.error('Error checking room status:', error);
                }
            }
        }, 60000); // Check every minute

        // Rest of the code remains the same
    </script>
</body>
</html>
